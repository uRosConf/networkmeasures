#' Network vulnerability per node
#' 
#' The \code{vulnerability}, according to Gol'dshtein (2004) and Latora et al (2005).
#'
#' @param g a graph
#' @param efficiency A precomputed efficiency for \code{g} (optional)
#'
#' @references Goldshtein, V., Koganov, G. A., & Surdutovich, G. I. (2004). Vulnerability and Hierarchy of Complex Networks. Cond-mat/0409298.
#' @references Latora, V., & Marchiori, M. (2005). Vulnerability and protection of infrastructure networks. Physical Review E, 71(1), 015103.
#' @export
vulnerability <- function(g, efficiency=NULL){
  e <- if(is.null(efficiency)) efficiency(g) else efficiency
  nodes <- V(g)
  out <- sapply(seq_along(nodes), function(i){
    h <- delete_edges(g, incident_edges(g,nodes[i])[[1]]) # shouldn't the node be removed as well?
    1-efficiency(h)/e
  })
  names(out) <- V(g)$name
  out
}
# didn't read the definition in the paper in detail, but it seems to me that the efficiency gets
# heavily skewed when you leave the (now completely unconnected) node in the graph
# that effect is strong, especially for small networks.
# plus if we consider it "destroyed" it should be gone?!
# shouldn't it be removed like so:
#' Network vulnerability per node
#' 
#' The \code{vulnerability}, according to Gol'dshtein (2004) and Latora et al (2005).
#'
#' @param g a graph
#' @param efficiency A precomputed efficiency for \code{g} (optional)
#'
#' @references Goldshtein, V., Koganov, G. A., & Surdutovich, G. I. (2004). Vulnerability and Hierarchy of Complex Networks. Cond-mat/0409298.
#' @references Latora, V., & Marchiori, M. (2005). Vulnerability and protection of infrastructure networks. Physical Review E, 71(1), 015103.
#' @export
vulnerability_nodes <- function(g, efficiency=NULL){
  e <- if(is.null(efficiency)) efficiency(g) else efficiency
  nodes <- V(g)
  out <- sapply(seq_along(nodes), function(i){
    h <- delete_vertices(g, nodes[i]) # shouldn't the node be removed as well?
    1-efficiency(h)/e
  })
  names(out) <- V(g)$name
  out
}
#' Network vulnerability per edge
#' 
#' The \code{vulnerability}, according to Gol'dshtein (2004) and Latora et al (2005).
#'
#' @param g a graph
#' @param efficiency A precomputed efficiency for \code{g} (optional)
#'
#' @references Goldshtein, V., Koganov, G. A., & Surdutovich, G. I. (2004). Vulnerability and Hierarchy of Complex Networks. Cond-mat/0409298.
#' @references Latora, V., & Marchiori, M. (2005). Vulnerability and protection of infrastructure networks. Physical Review E, 71(1), 015103.
#' @export
vulnerability_edges <- function(g, efficiency=NULL){
  e <- if(is.null(efficiency)) efficiency(g) else efficiency
  h_list <- purrr::map(E(g), ~ delete_edges(g, .x)) 
  out <-  purrr::map_dbl(h_list, ~1-efficiency(.x)/e)
  names(out) <- E(g)$name
  out
}
